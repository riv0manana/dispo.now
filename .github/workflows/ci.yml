name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_call:

permissions:
  contents: read
  pull-requests: write
  
jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: lts

      - name: Run Core Unit Tests
        # Runs domain logic, use cases, policies, and fakes verification
        run: deno test --allow-env --allow-read core/tests

      - name: Run E2E & Stress Tests
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://dummy:dummy@localhost:5432/dummy
          JWT_SECRET: ci_test_secret
          RATE_LIMIT_MAX=100: 100
          ALLOWED_ORIGINS: "*"
        run: deno test --no-check --allow-env --allow-read --allow-net app/tests
